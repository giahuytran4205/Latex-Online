name: Deploy to Termux Server (Pull Mode)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TERMUX_HOST }}
          port: ${{ secrets.TERMUX_PORT }}
          username: ${{ secrets.TERMUX_USER }}
          key: ${{ secrets.TERMUX_SSH_KEY }}
          script_stop: true
          script: |
            echo "üöÄ Starting Pull-Based Deployment..."
            
            # Configuration
            REPO_URL="https://github.com/giahuytran4205/Latex-Online.git"
            PROJECT_DIR="/data/data/com.termux/files/home/latex-online"
            
            # Ensure proper environment
            export PATH=$PATH:/data/data/com.termux/files/usr/bin
            
            # Ensure git is installed
            if ! command -v git &> /dev/null; then
                echo "Installing git..."
                pkg install -y git
            fi

            # 1. Update Codebase
            if [ -d "$PROJECT_DIR/.git" ]; then
                echo "üì• Pulling latest changes..."
                cd "$PROJECT_DIR"
                git reset --hard
                git pull
            else
                echo "‚ú® Cloning repository..."
                rm -rf "$PROJECT_DIR"
                git clone "$REPO_URL" "$PROJECT_DIR"
                cd "$PROJECT_DIR"
            fi
            
            # 2. Build Client
            echo "üì¶ Building Client..."
            cd client
            # Only install if package.json changed or node_modules missing (optimization)
            if [ ! -d "node_modules" ] || [ $(git diff --name-only HEAD@{1} HEAD | grep "client/package.json") ]; then
                npm install
            else
                echo "Skipping npm install for client (no changes detected)"
            fi
            npm run build
            
            # 3. Setup Server
            echo "üîß Setting up Server..."
            cd ../server
            npm install --production
            
            # 4. Restart Server
            echo "üîÑ Restarting Server..."
            # Stop existing process safely
            pkill -f "node index.js" || true
            sleep 2
            
            # Start new process
            nohup node index.js > ../server.log 2>&1 &
            
            # Verification
            sleep 5
            PID=$(pgrep -f "node index.js")
            if [ -n "$PID" ]; then
                echo "‚úÖ Server started with PID $PID"
            else
                echo "‚ùå Server failed to start. checking logs:"
                tail -n 20 ../server.log
                exit 1
            fi
