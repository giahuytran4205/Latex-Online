name: Deploy to Termux Server (Pull Mode)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TERMUX_HOST }}
          port: ${{ secrets.TERMUX_PORT }}
          username: ${{ secrets.TERMUX_USER }}
          key: ${{ secrets.TERMUX_SSH_KEY }}
          script_stop: false
          script: |
            set -e
            set -x # Enable debug logging
            
            echo "üöÄ Starting Pull-Based Deployment..."
            
            # Configuration
            REPO_URL="https://github.com/giahuytran4205/Latex-Online.git"
            PROJECT_DIR="/data/data/com.termux/files/home/latex-online"
            
            # Ensure proper environment
            export PATH="$PATH:/data/data/com.termux/files/usr/bin"
            
            # Ensure git is installed
            if ! command -v git &> /dev/null; then
                echo "Installing git..."
                pkg install -y git || { echo "Failed to install git"; exit 1; }
            fi

            # 1. Update Codebase
            SHOULD_INSTALL_CLIENT=false
            
            if [ -d "$PROJECT_DIR/.git" ]; then
                echo "üì• Pulling latest changes..."
                cd "$PROJECT_DIR"
                git reset --hard
                # Capture current commit to compare later
                OLD_HEAD=$(git rev-parse HEAD)
                git pull
                NEW_HEAD=$(git rev-parse HEAD)
                
                # Check if client/package.json changed between old and new head
                if [ "$OLD_HEAD" != "$NEW_HEAD" ]; then
                    if git diff --name-only "$OLD_HEAD" "$NEW_HEAD" | grep -q "client/package.json"; then
                        SHOULD_INSTALL_CLIENT=true
                    fi
                fi
            else
                echo "‚ú® Cloning repository..."
                rm -rf "$PROJECT_DIR"
                git clone "$REPO_URL" "$PROJECT_DIR" || { echo "Git clone failed. Is the repo private?"; exit 1; }
                cd "$PROJECT_DIR"
                SHOULD_INSTALL_CLIENT=true
            fi
            
            # 2. Build Client
            echo "üì¶ Building Client..."
            cd client
            
            if [ ! -d "node_modules" ]; then
                SHOULD_INSTALL_CLIENT=true
            fi
            
            if [ "$SHOULD_INSTALL_CLIENT" = true ]; then
                echo "Installing client dependencies..."
                npm install
            else
                echo "Skipping npm install for client (no changes detected)"
            fi
            
            npm run build
            
            # 3. Setup Server
            echo "üîß Setting up Server..."
            cd ../server
            npm install --production
            
            # 4. Restart Server
            echo "üîÑ Restarting Server..."
            # Stop existing process safely
            # Be ultra-specific: finding node process with index.js, but excluding our own deployment script if checking full path
            # We explicitly ignore the grep/pgrep process itself
            PIDS=$(pgrep -f "node index.js" | grep -v $$ || echo "")
            
            if [ -n "$PIDS" ]; then
                # Replace newlines with spaces for kill command
                PIDS_ONELINE=$(echo "$PIDS" | tr '\n' ' ')
                echo "Stopping PIDs: $PIDS_ONELINE"
                for PID in $PIDS; do
                    kill $PID 2>/dev/null || true
                done
                sleep 2
            fi
            
            # Start new process
            nohup node index.js > ../server.log 2>&1 &
            
            # Verification
            sleep 5
            PID=$(pgrep -f "node index.js")
            if [ -n "$PID" ]; then
                echo "‚úÖ Server started with PID $PID"
            else
                echo "‚ùå Server failed to start. checking logs:"
                tail -n 20 ../server.log
                exit 1
            fi
